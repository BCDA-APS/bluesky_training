

<!DOCTYPE html>


<html lang="en" >

  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" /><meta name="generator" content="Docutils 0.18.1: http://docutils.sourceforge.net/" />

    <title>Dynamic Limits for Two Motors &#8212; APS Bluesky Training  documentation</title>
  
  
  
  <script data-cfasync="false">
    document.documentElement.dataset.mode = localStorage.getItem("mode") || "";
    document.documentElement.dataset.theme = localStorage.getItem("theme") || "light";
  </script>
  
  <!-- Loaded before other Sphinx assets -->
  <link href="../_static/styles/theme.css?digest=e353d410970836974a52" rel="stylesheet" />
<link href="../_static/styles/bootstrap.css?digest=e353d410970836974a52" rel="stylesheet" />
<link href="../_static/styles/pydata-sphinx-theme.css?digest=e353d410970836974a52" rel="stylesheet" />

  
  <link href="../_static/vendor/fontawesome/6.1.2/css/all.min.css?digest=e353d410970836974a52" rel="stylesheet" />
  <link rel="preload" as="font" type="font/woff2" crossorigin href="../_static/vendor/fontawesome/6.1.2/webfonts/fa-solid-900.woff2" />
<link rel="preload" as="font" type="font/woff2" crossorigin href="../_static/vendor/fontawesome/6.1.2/webfonts/fa-brands-400.woff2" />
<link rel="preload" as="font" type="font/woff2" crossorigin href="../_static/vendor/fontawesome/6.1.2/webfonts/fa-regular-400.woff2" />

    <link rel="stylesheet" type="text/css" href="../_static/pygments.css" />
    <link rel="stylesheet" type="text/css" href="../_static/graphviz.css" />
    <link rel="stylesheet" type="text/css" href="../_static/tabs.css" />
  
  <!-- Pre-loaded scripts that we'll load fully later -->
  <link rel="preload" as="script" href="../_static/scripts/bootstrap.js?digest=e353d410970836974a52" />
<link rel="preload" as="script" href="../_static/scripts/pydata-sphinx-theme.js?digest=e353d410970836974a52" />

    <script data-url_root="../" id="documentation_options" src="../_static/documentation_options.js"></script>
    <script src="../_static/jquery.js"></script>
    <script src="../_static/underscore.js"></script>
    <script src="../_static/_sphinx_javascript_frameworks_compat.js"></script>
    <script src="../_static/doctools.js"></script>
    <script src="../_static/sphinx_highlight.js"></script>
    <script crossorigin="anonymous" integrity="sha256-Ae2Vz/4ePdIu6ZyI/5ZGsYnb+m0JlOmKPjt6XZ9JJkA=" src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.4/require.min.js"></script>
    <script>window.MathJax = {"tex": {"inlineMath": [["$", "$"], ["\\(", "\\)"]], "processEscapes": true}, "options": {"ignoreHtmlClass": "tex2jax_ignore|mathjax_ignore|document", "processHtmlClass": "tex2jax_process|mathjax_process|math|output_area"}}</script>
    <script defer="defer" src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" />
    <link rel="next" title="Images, Darks, &amp; whites with EPICS area detector, ophyd, and Bluesky" href="_images_darks_flats.html" />
    <link rel="prev" title="Linux Command &amp; Wait for Finish" href="_doodle.html" />
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <meta name="docsearch:language" content="en"/>
  </head>
  
  
  <body data-bs-spy="scroll" data-bs-target=".bd-toc-nav" data-offset="180" data-bs-root-margin="0px 0px -60%" data-default-mode="">

  
  
  <a class="skip-link" href="#main-content">Skip to main content</a>
  
  <input type="checkbox"
          class="sidebar-toggle"
          name="__primary"
          id="__primary"/>
  <label class="overlay overlay-primary" for="__primary"></label>
  
  <input type="checkbox"
          class="sidebar-toggle"
          name="__secondary"
          id="__secondary"/>
  <label class="overlay overlay-secondary" for="__secondary"></label>
  
  <div class="search-button__wrapper">
    <div class="search-button__overlay"></div>
    <div class="search-button__search-container">
<form class="bd-search d-flex align-items-center"
      action="../search.html"
      method="get">
  <i class="fa-solid fa-magnifying-glass"></i>
  <input type="search"
         class="form-control"
         name="q"
         id="search-input"
         placeholder="Search the docs ..."
         aria-label="Search the docs ..."
         autocomplete="off"
         autocorrect="off"
         autocapitalize="off"
         spellcheck="false"/>
  <span class="search-button__kbd-shortcut"><kbd class="kbd-shortcut__modifier">Ctrl</kbd>+<kbd>K</kbd></span>
</form></div>
  </div>
  
    <nav class="bd-header navbar navbar-expand-lg bd-navbar">
<div class="bd-header__inner bd-page-width">
  <label class="sidebar-toggle primary-toggle" for="__primary">
    <span class="fa-solid fa-bars"></span>
  </label>
  
  <div class="navbar-header-items__start">
    
      <div class="navbar-item">
  

<a class="navbar-brand logo" href="../index.html">
  
  
  
  
  
    <p class="title logo__title">APS Bluesky Training  documentation</p>
  
</a></div>
    
  </div>
  
  
  <div class="col-lg-9 navbar-header-items">
    
    <div class="me-auto navbar-header-items__center">
      
        <div class="navbar-item"><nav class="navbar-nav">
  <p class="sidebar-header-items__title"
     role="heading"
     aria-level="1"
     aria-label="Site Navigation">
    Site Navigation
  </p>
  <ul class="bd-navbar-elements navbar-nav">
    
                    <li class="nav-item current active">
                      <a class="nav-link nav-internal" href="index.html">
                        How-To Guides
                      </a>
                    </li>
                

                    <li class="nav-item">
                      <a class="nav-link nav-internal" href="../instrument/index.html">
                        Instrument
                      </a>
                    </li>
                

                    <li class="nav-item">
                      <a class="nav-link nav-internal" href="../example/index.html">
                        Examples
                      </a>
                    </li>
                

                    <li class="nav-item">
                      <a class="nav-link nav-internal" href="../tutor/index.html">
                        Tutorials
                      </a>
                    </li>
                

                    <li class="nav-item">
                      <a class="nav-link nav-internal" href="../reference/index.html">
                        Reference
                      </a>
                    </li>
                
  </ul>
</nav></div>
      
    </div>
    
    
    <div class="navbar-header-items__end">
      
        <div class="navbar-item navbar-persistent--container">
          
<script>
document.write(`
  <button class="btn btn-sm navbar-btn search-button search-button__button" title="Search" aria-label="Search" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <i class="fa-solid fa-magnifying-glass"></i>
  </button>
`);
</script>
        </div>
      
      
        <div class="navbar-item">
<script>
document.write(`
  <button class="theme-switch-button btn btn-sm btn-outline-primary navbar-btn rounded-circle" title="light/dark" aria-label="light/dark" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <span class="theme-switch" data-mode="light"><i class="fa-solid fa-sun"></i></span>
    <span class="theme-switch" data-mode="dark"><i class="fa-solid fa-moon"></i></span>
    <span class="theme-switch" data-mode="auto"><i class="fa-solid fa-circle-half-stroke"></i></span>
  </button>
`);
</script></div>
      
    </div>
    
  </div>
  
  
    <div class="navbar-persistent--mobile">
<script>
document.write(`
  <button class="btn btn-sm navbar-btn search-button search-button__button" title="Search" aria-label="Search" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <i class="fa-solid fa-magnifying-glass"></i>
  </button>
`);
</script>
    </div>
  

  
    <label class="sidebar-toggle secondary-toggle" for="__secondary">
      <span class="fa-solid fa-outdent"></span>
    </label>
  
</div>

    </nav>
  
  <div class="bd-container">
    <div class="bd-container__inner bd-page-width">
      
      <div class="bd-sidebar-primary bd-sidebar">
        

  
  <div class="sidebar-header-items sidebar-primary__section">
    
    
      <div class="sidebar-header-items__center">
        
          <div class="navbar-item"><nav class="navbar-nav">
  <p class="sidebar-header-items__title"
     role="heading"
     aria-level="1"
     aria-label="Site Navigation">
    Site Navigation
  </p>
  <ul class="bd-navbar-elements navbar-nav">
    
                    <li class="nav-item current active">
                      <a class="nav-link nav-internal" href="index.html">
                        How-To Guides
                      </a>
                    </li>
                

                    <li class="nav-item">
                      <a class="nav-link nav-internal" href="../instrument/index.html">
                        Instrument
                      </a>
                    </li>
                

                    <li class="nav-item">
                      <a class="nav-link nav-internal" href="../example/index.html">
                        Examples
                      </a>
                    </li>
                

                    <li class="nav-item">
                      <a class="nav-link nav-internal" href="../tutor/index.html">
                        Tutorials
                      </a>
                    </li>
                

                    <li class="nav-item">
                      <a class="nav-link nav-internal" href="../reference/index.html">
                        Reference
                      </a>
                    </li>
                
  </ul>
</nav></div>
        
      </div>
    
    
    
      <div class="sidebar-header-items__end">
        
          <div class="navbar-item">
<script>
document.write(`
  <button class="theme-switch-button btn btn-sm btn-outline-primary navbar-btn rounded-circle" title="light/dark" aria-label="light/dark" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <span class="theme-switch" data-mode="light"><i class="fa-solid fa-sun"></i></span>
    <span class="theme-switch" data-mode="dark"><i class="fa-solid fa-moon"></i></span>
    <span class="theme-switch" data-mode="auto"><i class="fa-solid fa-circle-half-stroke"></i></span>
  </button>
`);
</script></div>
        
      </div>
    
  </div>
  
    <div class="sidebar-primary-items__start sidebar-primary__section">
        <div class="sidebar-primary-item"><nav class="bd-docs-nav bd-links"
     aria-label="Section Navigation">
  <p class="bd-links__title" role="heading" aria-level="1">Section Navigation</p>
  <div class="bd-toc-item navbar-nav"><ul class="current nav bd-sidenav">
<li class="toctree-l1"><a class="reference internal" href="getting_started.html">Getting started</a></li>
<li class="toctree-l1"><a class="reference internal" href="bluesky_cheat_sheet.html">Bluesky Cheat Sheet</a></li>
<li class="toctree-l1"><a class="reference internal" href="_after_measurement.html">Accessing data later, after the measurement</a></li>
<li class="toctree-l1"><a class="reference internal" href="_basic_aps_info.html">APS Accelerator Information for Beam Lines</a></li>
<li class="toctree-l1"><a class="reference internal" href="_basic_motor_scaler_scan.html">Minimal: Scan scaler <em>vs</em> motor</a></li>
<li class="toctree-l1"><a class="reference internal" href="_bluesky_queueserver.html">First steps with bluesky-queueserver</a></li>
<li class="toctree-l1"><a class="reference internal" href="_count_scaler.html">Count the scaler</a></li>
<li class="toctree-l1"><a class="reference internal" href="_custom_heater_positioner.html">Heater Simulation using synApps epid and transform records</a></li>
<li class="toctree-l1"><a class="reference internal" href="_custom_plan.html">Custom bluesky plan</a></li>

<li class="toctree-l1"><a class="reference internal" href="_doodle.html">Linux Command &amp; Wait for Finish</a></li>
<li class="toctree-l1 current active"><a class="current reference internal" href="#">Dynamic Limits for Two Motors</a></li>
<li class="toctree-l1"><a class="reference internal" href="_images_darks_flats.html">Images, Darks, &amp; whites with EPICS area detector, ophyd, and Bluesky</a></li>
<li class="toctree-l1"><a class="reference internal" href="_lineup_1d_peak.html">Lineup a 1-D peak : scan detector <em>v</em> motor</a></li>
<li class="toctree-l1"><a class="reference internal" href="_locate_image_peak.html">Locate peak on 2-D area detector image</a></li>
<li class="toctree-l1"><a class="reference internal" href="_plot_x_y_databroker.html">Plot x, y data from a databroker run</a></li>
<li class="toctree-l1"><a class="reference internal" href="_synapps_busy.html">synApps <em>busy</em> record</a></li>
<li class="toctree-l1"><a class="reference internal" href="_synapps_sscan_1d_flyer.html">synApps <em>sscan</em> as 1D Flyer</a></li>
</ul>
</div>
</nav></div>
    </div>
  
  
  <div class="sidebar-primary-items__end sidebar-primary__section">
  </div>
  
  <div id="rtd-footer-container"></div>


      </div>
      
      <main id="main-content" class="bd-main">
        
        
          <div class="bd-content">
            <div class="bd-article-container">
              
              <div class="bd-header-article">
<div class="header-article-items header-article__inner">
  
    <div class="header-article-items__start">
      
        <div class="header-article-item">



<nav aria-label="Breadcrumbs">
  <ul class="bd-breadcrumbs" role="navigation" aria-label="Breadcrumb">
    
    <li class="breadcrumb-item breadcrumb-home">
      <a href="../index.html" class="nav-link" aria-label="Home">
        <i class="fa-solid fa-home"></i>
      </a>
    </li>
    
    <li class="breadcrumb-item"><a href="index.html" class="nav-link">How-To Guides</a></li>
    
    <li class="breadcrumb-item active" aria-current="page">Dynamic Limits for Two Motors</li>
  </ul>
</nav>
</div>
      
    </div>
  
  
</div>
</div>
              
              
              
                
<div id="searchbox"></div>
                <article class="bd-article" role="main">
                  
  <section id="Dynamic-Limits-for-Two-Motors">
<h1>Dynamic Limits for Two Motors<a class="headerlink" href="#Dynamic-Limits-for-Two-Motors" title="Permalink to this heading">#</a></h1>
<section id="Overview">
<h2>Overview<a class="headerlink" href="#Overview" title="Permalink to this heading">#</a></h2>
<p>Some instrument designs need protection against accidental collision between moving parts during routine operations. In such cases, each of the axes may be operating between its valid range but an interim (in-motion) state can pose the possibility of a collision.</p>
<p>One such possible collision is when arms of a diffractometer (such as <span class="math notranslate nohighlight">\(\theta\)</span> and <span class="math notranslate nohighlight">\(2\theta\)</span>, known here as <code class="docutils literal notranslate"><span class="pre">theta</span></code> and <code class="docutils literal notranslate"><span class="pre">ttheta</span></code>, respectively) collide causing damage to beam transport apparatus and consequential instrumental downtime.</p>
<p>To prevent the collision <em>in this case</em>, the <span class="math notranslate nohighlight">\(2\theta\)</span> axis must be at least <span class="math notranslate nohighlight">\(\delta\)</span> degrees above the <span class="math notranslate nohighlight">\(\theta\)</span> axis. Empirically, <span class="math notranslate nohighlight">\(\delta\)</span> of 3 degrees is sufficient protection.</p>
<p>From a controls safety view, we provide an EPICS PV calculation that is zero when the move is not permitted and one when: (<span class="math notranslate nohighlight">\(2\theta - \theta) \ge \delta\)</span>. We’ll monitor that PV in Bluesky to add a <a class="reference external" href="https://blueskyproject.io/bluesky/state-machine.html#automated-suspension">suspender</a> that can interrupt the scan (via the <code class="docutils literal notranslate"><span class="pre">`bluesky.RunEngine</span></code> &lt;<a class="reference external" href="https://blueskyproject.io/bluesky/run_engine_api.html?highlight=runengine">https://blueskyproject.io/bluesky/run_engine_api.html?highlight=runengine</a>&gt;`__) if the permit is removed. When the RunEngine handles an
interruption involving <a class="reference external" href="https://blueskyproject.io/bluesky/hardware.html?highlight=movables#settable-movable-device">movable devices</a>, it sends a stop to each of the movables involved. Thus, when the dynamic limit permit is removed, both motors are stopped and the scan pauses, waiting for external interaction to clear the condition.</p>
<details><p><a class="reference external" href="https://github.com/bluesky/bluesky/blob/4fab894bddbd4a563f28852ea3171b87140ae7b9/bluesky/run_engine.py#L1034-L1036">Here</a> is where bluesky tells the motors to stop:</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>if justification is not None:
    print(&quot;Justification for this suspension:\n%s&quot; % justification)
for current_run in self._run_bundlers.values():
    current_run.record_interruption(&#39;resume&#39;)
# During suspend, all motors should be stopped. Call stop() on
# every object we ever set().
self._stop_movable_objects(success=True)
</pre></div>
</div>
<p>If the RunEngine is started while the dynamic limit permit calculation is zero, the RunEngine will pause immediately. Here is an example:</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>In [21]: uid = RE(th_tth_scan([noisy, th_tth_permit], 8, 6, points=4, min_sep=3))
At least one suspender has tripped. The plan will begin when all suspenders are ready. Justification:
    1. Signal th_tth_permit is low

Suspending... To get to the prompt, hit Ctrl-C twice to pause.
</pre></div>
</div>
<p>We might need to write our own suspender if none of the <a class="reference external" href="https://blueskyproject.io/bluesky/state-machine.html#built-in-suspenders">provided suspenders</a> will do the job we want.</p>
</details></section>
<section id="Summary">
<h2>Summary<a class="headerlink" href="#Summary" title="Permalink to this heading">#</a></h2>
<p>Any time the motors are moved by the bluesky RunEngine, they will be stopped if the dynamic limit permit calculation goes to zero and the scan will pause.</p>
</section>
<section id="EPICS-setup">
<h2>EPICS setup<a class="headerlink" href="#EPICS-setup" title="Permalink to this heading">#</a></h2>
<p>We start with two motor axes defined in EPICS. Here, we run the docker image <code class="docutils literal notranslate"><span class="pre">`prjemian/synApps</span></code> &lt;<a class="reference external" href="https://hub.docker.com/r/prjemian/synapps">https://hub.docker.com/r/prjemian/synapps</a>&gt;`__ to make the <a class="reference external" href="https://github.com/prjemian/epics-docker/#custom-synappshttps://github.com/prjemian/epics-docker/#custom-synapps">EPICS IOC simulator run in a docker container</a> with IOC prefix <code class="docutils literal notranslate"><span class="pre">gp:</span></code>. These are motor PVs: <code class="docutils literal notranslate"><span class="pre">gp:m1</span></code> and <code class="docutils literal notranslate"><span class="pre">gp:m2</span></code> as shown.</p>
<p><img alt="EPICS motor GUI screens" src="../_images/demo_dynamic_limits_motors.png" /></p>
<p>To compute a dynamic limit between the two motor axes, we use a <em>userCalc</em> (EPICS <a class="reference external" href="https://htmlpreview.github.io/?https://raw.githubusercontent.com/epics-modules/calc/R3-6-1/documentation/swaitRecord.html">swait</a> record), <code class="docutils literal notranslate"><span class="pre">gp:userCalc1</span></code> with settings as shown.</p>
<ol class="arabic simple">
<li><p>Set the description field to describe what this does.</p></li>
<li><p>Monitor each motor’s readback (<code class="docutils literal notranslate"><span class="pre">.RBV</span></code>) value. The readback value is the motor record’s <em>best</em> knowledge of the actual motor position.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">gp:userCalc1.INAN</span></code> = <code class="docutils literal notranslate"><span class="pre">sky:m1.RBV</span></code>, the value will be in <code class="docutils literal notranslate"><span class="pre">A</span></code> once the motor moves.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">gp:userCalc1.INBN</span></code> = <code class="docutils literal notranslate"><span class="pre">sky:m2.RBV</span></code>, the value will be in <code class="docutils literal notranslate"><span class="pre">B</span></code> once the motor moves.</p></li>
<li><p>Change the calculation’s <code class="docutils literal notranslate"><span class="pre">.SCAN</span></code> field from <em>Passive</em> (calculates only when requested) to <em>I/O Intr</em> (calculate when any input changes, based on each field’s <em>TRIGGER?</em> setting).</p></li>
<li><p>Enter the angle of minimum approach (3) into the <code class="docutils literal notranslate"><span class="pre">gp:userCalc1.C</span></code> field. This will be the PV to change this number.</p></li>
<li><p>Enter the permit calculation: <code class="docutils literal notranslate"><span class="pre">(B-A)&gt;=C</span></code></p></li>
</ol>
<p>The calculated result (in <code class="docutils literal notranslate"><span class="pre">gp:userCalc1.VAL</span></code>, <code class="docutils literal notranslate"><span class="pre">gp:userCalc1</span></code> for short) once either of the motors move.</p>
<p><img alt="motion permit calculation" src="../_images/demo_dynamic_limits_permit_calc.png" /></p>
<p>To scan, we want a “detector”. Let’s use another <em>userCalc</em> (<code class="docutils literal notranslate"><span class="pre">gp:userCalc2</span></code>) to simulate a noisy detector with a random number generator. We’ll update this detector only when either motor moves (same as with the permit calculation) setting its <code class="docutils literal notranslate"><span class="pre">.SCAN</span></code> to <em>I/O Intr</em>. The setup is shown in the next screen view image:</p>
<p><img alt="noisy detector simulation" src="../_images/demo_dynamic_limits_permit_noisy.png" /></p>
</section>
<section id="Bluesky-setup">
<h2>Bluesky setup<a class="headerlink" href="#Bluesky-setup" title="Permalink to this heading">#</a></h2>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[1]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># put the instrument package into the path</span>
<span class="kn">import</span> <span class="nn">pathlib</span><span class="o">,</span> <span class="nn">sys</span>
<span class="n">sys</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">pathlib</span><span class="o">.</span><span class="n">Path</span><span class="o">.</span><span class="n">home</span><span class="p">()</span> <span class="o">/</span> <span class="s2">&quot;bluesky&quot;</span><span class="p">))</span>

<span class="c1"># start the instrument package for data collection</span>
<span class="kn">from</span> <span class="nn">instrument.collection</span> <span class="kn">import</span> <span class="o">*</span>
<span class="kn">from</span> <span class="nn">bluesky</span> <span class="kn">import</span> <span class="n">plans</span> <span class="k">as</span> <span class="n">bp</span>
<span class="kn">from</span> <span class="nn">bluesky</span> <span class="kn">import</span> <span class="n">plan_stubs</span> <span class="k">as</span> <span class="n">bps</span>
<span class="kn">from</span> <span class="nn">ophyd</span> <span class="kn">import</span> <span class="n">Component</span><span class="p">,</span> <span class="n">Device</span><span class="p">,</span> <span class="n">EpicsMotor</span><span class="p">,</span> <span class="n">EpicsSignal</span>

<span class="n">bec</span><span class="o">.</span><span class="n">disable_plots</span><span class="p">()</span>  <span class="c1"># not interested in graphics in this notebook</span>
<span class="n">RE</span><span class="o">.</span><span class="n">waiting_hook</span> <span class="o">=</span> <span class="kc">None</span>  <span class="c1"># disable the progress bar, looks awful in notebooks</span>
</pre></div>
</div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
/home/prjemian/bluesky/instrument/_iconfig.py
Activating auto-logging. Current session state plus future input saved.
Filename       : /home/prjemian/Documents/projects/BCDA-APS/bluesky_training/docs/source/howto/.logs/ipython_console.log
Mode           : rotate
Output logging : True
Raw input log  : False
Timestamping   : True
State          : active
</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area stderr docutils container">
<div class="highlight"><pre>
I Tue-18:47:27 - ############################################################ startup
I Tue-18:47:27 - logging started
I Tue-18:47:27 - logging level = 10
I Tue-18:47:27 - /home/prjemian/bluesky/instrument/session_logs.py
I Tue-18:47:27 - /home/prjemian/bluesky/instrument/collection.py
I Tue-18:47:27 - CONDA_PREFIX = /home/prjemian/.conda/envs/bluesky_2023_2
</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
Exception reporting mode: Minimal
</pre></div></div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area stderr docutils container">
<div class="highlight"><pre>
I Tue-18:47:27 - xmode exception level: &#39;Minimal&#39;
I Tue-18:47:27 - /home/prjemian/bluesky/instrument/mpl/notebook.py
I Tue-18:47:27 - #### Bluesky Framework ####
I Tue-18:47:27 - /home/prjemian/bluesky/instrument/framework/check_python.py
I Tue-18:47:27 - /home/prjemian/bluesky/instrument/framework/check_bluesky.py
I Tue-18:47:27 - /home/prjemian/bluesky/instrument/framework/initialize.py
I Tue-18:47:27 - RunEngine metadata saved in directory: /home/prjemian/Bluesky_RunEngine_md
I Tue-18:47:28 - using databroker catalog &#39;training&#39;
I Tue-18:47:28 - using ophyd control layer: pyepics
I Tue-18:47:28 - /home/prjemian/bluesky/instrument/framework/metadata.py
I Tue-18:47:28 - /home/prjemian/bluesky/instrument/epics_signal_config.py
I Tue-18:47:28 - Using RunEngine metadata for scan_id
I Tue-18:47:28 - #### Devices ####
I Tue-18:47:28 - /home/prjemian/bluesky/instrument/devices/area_detector.py
I Tue-18:47:28 - /home/prjemian/bluesky/instrument/devices/calculation_records.py
I Tue-18:47:30 - /home/prjemian/bluesky/instrument/devices/fourc_diffractometer.py
I Tue-18:47:30 - /home/prjemian/bluesky/instrument/devices/ioc_stats.py
I Tue-18:47:30 - /home/prjemian/bluesky/instrument/devices/kohzu_monochromator.py
I Tue-18:47:30 - /home/prjemian/bluesky/instrument/devices/motors.py
I Tue-18:47:30 - /home/prjemian/bluesky/instrument/devices/noisy_detector.py
I Tue-18:47:30 - /home/prjemian/bluesky/instrument/devices/scaler.py
I Tue-18:47:31 - /home/prjemian/bluesky/instrument/devices/shutter_simulator.py
I Tue-18:47:31 - /home/prjemian/bluesky/instrument/devices/simulated_fourc.py
I Tue-18:47:31 - /home/prjemian/bluesky/instrument/devices/simulated_kappa.py
I Tue-18:47:31 - /home/prjemian/bluesky/instrument/devices/sixc_diffractometer.py
I Tue-18:47:32 - /home/prjemian/bluesky/instrument/devices/temperature_signal.py
I Tue-18:47:32 - #### Callbacks ####
I Tue-18:47:32 - /home/prjemian/bluesky/instrument/callbacks/spec_data_file_writer.py
I Tue-18:47:32 - #### Plans ####
I Tue-18:47:32 - /home/prjemian/bluesky/instrument/plans/lup_plan.py
I Tue-18:47:32 - /home/prjemian/bluesky/instrument/plans/peak_finder_example.py
I Tue-18:47:32 - /home/prjemian/bluesky/instrument/utils/image_analysis.py
I Tue-18:47:32 - #### Utilities ####
I Tue-18:47:32 - writing to SPEC file: /home/prjemian/Documents/projects/BCDA-APS/bluesky_training/docs/source/howto/20230411-184732.dat
I Tue-18:47:32 -    &gt;&gt;&gt;&gt;   Using default SPEC file name   &lt;&lt;&lt;&lt;
I Tue-18:47:32 -    file will be created when bluesky ends its next scan
I Tue-18:47:32 -    to change SPEC file, use command:   newSpecFile(&#39;title&#39;)
I Tue-18:47:32 - #### Startup is complete. ####
</pre></div></div>
</div>
<table class="table">
<thead>
<tr class="row-odd"><th class="head"><p>symbol</p></th>
<th class="head"><p>PV (here)</p></th>
<th class="head"><p>meaning</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><p><code class="docutils literal notranslate"><span class="pre">theta</span></code></p></td>
<td><p>gp:m1</p></td>
<td><p>(<code class="docutils literal notranslate"><span class="pre">th</span></code>) EPICS motor record</p></td>
</tr>
<tr class="row-odd"><td><p><code class="docutils literal notranslate"><span class="pre">ttheta</span></code></p></td>
<td><p>gp:m2</p></td>
<td><p>(<code class="docutils literal notranslate"><span class="pre">tth</span></code>) EPICS motor record</p></td>
</tr>
<tr class="row-even"><td><p><code class="docutils literal notranslate"><span class="pre">th_tth_permit</span></code></p></td>
<td><p>gp:userCalc1.VAL</p></td>
<td><p>result of EPICS calculation (swait record: 1=permit, 0=not), updates when either motor moves</p></td>
</tr>
<tr class="row-odd"><td><p><code class="docutils literal notranslate"><span class="pre">th_tth_min</span></code></p></td>
<td><p>gp:userCalc1.C</p></td>
<td><p>minimum permitted <code class="docutils literal notranslate"><span class="pre">tth-th</span></code></p></td>
</tr>
<tr class="row-even"><td><p><code class="docutils literal notranslate"><span class="pre">noisy</span></code></p></td>
<td><p>gp:userCalc2.VAL</p></td>
<td><p>detector (random number generator) - integer, updates when either motor moves</p></td>
</tr>
<tr class="row-odd"><td><p><code class="docutils literal notranslate"><span class="pre">noisy_scale</span></code></p></td>
<td><p>gp:userCalc2.C</p></td>
<td><p>scale factor for <code class="docutils literal notranslate"><span class="pre">noisy</span></code></p></td>
</tr>
</tbody>
</table>
<p>Get the IOC prefix from the instrument configuration (<code class="docutils literal notranslate"><span class="pre">iconfig</span></code>). If not available, use <code class="docutils literal notranslate"><span class="pre">&quot;gp:&quot;</span></code> as the default.</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[2]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">GP_IOC</span> <span class="o">=</span> <span class="n">iconfig</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;GP_IOC_PREFIX&quot;</span><span class="p">,</span> <span class="s2">&quot;gp:&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<p>Define the objects we’ll use in this demo.</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[3]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">noisy</span> <span class="o">=</span> <span class="n">EpicsSignal</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">GP_IOC</span><span class="si">}</span><span class="s2">userCalc2.VAL&quot;</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s2">&quot;noisy&quot;</span><span class="p">)</span>
<span class="n">noisy_scale</span> <span class="o">=</span> <span class="n">EpicsSignal</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">GP_IOC</span><span class="si">}</span><span class="s2">userCalc2.C&quot;</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s2">&quot;noisy_scale&quot;</span><span class="p">)</span>
<span class="n">th_tth_min</span> <span class="o">=</span> <span class="n">EpicsSignal</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">GP_IOC</span><span class="si">}</span><span class="s2">userCalc1.C&quot;</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s2">&quot;th_tth_min&quot;</span><span class="p">)</span>
<span class="n">th_tth_permit</span> <span class="o">=</span> <span class="n">EpicsSignal</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">GP_IOC</span><span class="si">}</span><span class="s2">userCalc1.VAL&quot;</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s2">&quot;th_tth_permit&quot;</span><span class="p">)</span>
<span class="n">noisy</span><span class="o">.</span><span class="n">wait_for_connection</span><span class="p">()</span>
<span class="n">noisy_scale</span><span class="o">.</span><span class="n">wait_for_connection</span><span class="p">()</span>
<span class="n">th_tth_min</span><span class="o">.</span><span class="n">wait_for_connection</span><span class="p">()</span>
<span class="n">th_tth_permit</span><span class="o">.</span><span class="n">wait_for_connection</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[4]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># We do this ONLY in the simulator.  Real instrument motors may need different settings!</span>
<span class="c1"># For this demo, we want to set the theta &amp; ttheta motor backlash to the default condition</span>
<span class="c1"># when the IOC is first created.  We&#39;ll change this later in the demo.</span>

<span class="k">class</span> <span class="nc">BacklashMotor</span><span class="p">(</span><span class="n">EpicsMotor</span><span class="p">):</span>
    <span class="n">backlash_distance</span> <span class="o">=</span> <span class="n">Component</span><span class="p">(</span><span class="n">EpicsSignal</span><span class="p">,</span> <span class="s2">&quot;.BDST&quot;</span><span class="p">)</span>
    <span class="n">backlash_velocity</span> <span class="o">=</span> <span class="n">Component</span><span class="p">(</span><span class="n">EpicsSignal</span><span class="p">,</span> <span class="s2">&quot;.BVEL&quot;</span><span class="p">)</span>

<span class="n">theta</span> <span class="o">=</span> <span class="n">BacklashMotor</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">GP_IOC</span><span class="si">}</span><span class="s2">m1&quot;</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s2">&quot;theta&quot;</span><span class="p">,</span> <span class="n">labels</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;motors&quot;</span><span class="p">,])</span>
<span class="n">ttheta</span> <span class="o">=</span> <span class="n">BacklashMotor</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">GP_IOC</span><span class="si">}</span><span class="s2">m2&quot;</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s2">&quot;ttheta&quot;</span><span class="p">,</span> <span class="n">labels</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;motors&quot;</span><span class="p">,])</span>
<span class="n">theta</span><span class="o">.</span><span class="n">wait_for_connection</span><span class="p">()</span>
<span class="n">ttheta</span><span class="o">.</span><span class="n">wait_for_connection</span><span class="p">()</span>
<span class="o">%</span><span class="k">mov</span> ttheta.backlash_distance 0  ttheta.backlash_velocity 2  ttheta.velocity 2
<span class="o">%</span><span class="k">mov</span> theta.backlash_distance 0  theta.backlash_velocity 1  theta.velocity 2
</pre></div>
</div>
</div>
<p>Setup the two swait records as shown above.</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[5]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">calcs</span><span class="o">.</span><span class="n">calc1</span><span class="o">.</span><span class="n">reset</span><span class="p">()</span>
<span class="n">calcs</span><span class="o">.</span><span class="n">calc1</span><span class="o">.</span><span class="n">description</span><span class="o">.</span><span class="n">put</span><span class="p">(</span><span class="s2">&quot;(tth-th) permit&quot;</span><span class="p">)</span>
<span class="n">calcs</span><span class="o">.</span><span class="n">calc1</span><span class="o">.</span><span class="n">channels</span><span class="o">.</span><span class="n">A</span><span class="o">.</span><span class="n">input_pv</span><span class="o">.</span><span class="n">put</span><span class="p">(</span><span class="n">theta</span><span class="o">.</span><span class="n">user_readback</span><span class="o">.</span><span class="n">pvname</span><span class="p">)</span>
<span class="n">calcs</span><span class="o">.</span><span class="n">calc1</span><span class="o">.</span><span class="n">channels</span><span class="o">.</span><span class="n">B</span><span class="o">.</span><span class="n">input_pv</span><span class="o">.</span><span class="n">put</span><span class="p">(</span><span class="n">ttheta</span><span class="o">.</span><span class="n">user_readback</span><span class="o">.</span><span class="n">pvname</span><span class="p">)</span>
<span class="n">calcs</span><span class="o">.</span><span class="n">calc1</span><span class="o">.</span><span class="n">channels</span><span class="o">.</span><span class="n">C</span><span class="o">.</span><span class="n">input_value</span><span class="o">.</span><span class="n">put</span><span class="p">(</span><span class="mf">2.8</span><span class="p">)</span>
<span class="n">calcs</span><span class="o">.</span><span class="n">calc1</span><span class="o">.</span><span class="n">calculation</span><span class="o">.</span><span class="n">put</span><span class="p">(</span><span class="s2">&quot;(B-A)&gt;=C&quot;</span><span class="p">)</span>
<span class="n">calcs</span><span class="o">.</span><span class="n">calc1</span><span class="o">.</span><span class="n">precision</span><span class="o">.</span><span class="n">put</span><span class="p">(</span><span class="mi">5</span><span class="p">)</span>
<span class="n">calcs</span><span class="o">.</span><span class="n">calc1</span><span class="o">.</span><span class="n">scanning_rate</span><span class="o">.</span><span class="n">put</span><span class="p">(</span><span class="s2">&quot;I/O Intr&quot;</span><span class="p">)</span>

<span class="n">calcs</span><span class="o">.</span><span class="n">calc2</span><span class="o">.</span><span class="n">reset</span><span class="p">()</span>
<span class="n">calcs</span><span class="o">.</span><span class="n">calc2</span><span class="o">.</span><span class="n">description</span><span class="o">.</span><span class="n">put</span><span class="p">(</span><span class="s2">&quot;noisy&quot;</span><span class="p">)</span>
<span class="n">calcs</span><span class="o">.</span><span class="n">calc2</span><span class="o">.</span><span class="n">channels</span><span class="o">.</span><span class="n">A</span><span class="o">.</span><span class="n">input_pv</span><span class="o">.</span><span class="n">put</span><span class="p">(</span><span class="n">theta</span><span class="o">.</span><span class="n">user_readback</span><span class="o">.</span><span class="n">pvname</span><span class="p">)</span>
<span class="n">calcs</span><span class="o">.</span><span class="n">calc2</span><span class="o">.</span><span class="n">channels</span><span class="o">.</span><span class="n">B</span><span class="o">.</span><span class="n">input_pv</span><span class="o">.</span><span class="n">put</span><span class="p">(</span><span class="n">ttheta</span><span class="o">.</span><span class="n">user_readback</span><span class="o">.</span><span class="n">pvname</span><span class="p">)</span>
<span class="n">calcs</span><span class="o">.</span><span class="n">calc2</span><span class="o">.</span><span class="n">channels</span><span class="o">.</span><span class="n">C</span><span class="o">.</span><span class="n">input_value</span><span class="o">.</span><span class="n">put</span><span class="p">(</span><span class="mi">100_000</span><span class="p">)</span>
<span class="n">calcs</span><span class="o">.</span><span class="n">calc2</span><span class="o">.</span><span class="n">calculation</span><span class="o">.</span><span class="n">put</span><span class="p">(</span><span class="s2">&quot;floor(RNDM*C+.5)&quot;</span><span class="p">)</span>
<span class="n">calcs</span><span class="o">.</span><span class="n">calc2</span><span class="o">.</span><span class="n">precision</span><span class="o">.</span><span class="n">put</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
<span class="n">calcs</span><span class="o">.</span><span class="n">calc2</span><span class="o">.</span><span class="n">scanning_rate</span><span class="o">.</span><span class="n">put</span><span class="p">(</span><span class="s2">&quot;I/O Intr&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
</section>
<section id="Custom-Bluesky-plan-for-\theta:2\theta-scan">
<h2>Custom Bluesky plan for <span class="math notranslate nohighlight">\(\theta:2\theta\)</span> scan<a class="headerlink" href="#Custom-Bluesky-plan-for-\theta:2\theta-scan" title="Permalink to this heading">#</a></h2>
<p>Define a plan for a coupled theta:2theta scan.</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[6]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">th_tth_scan</span><span class="p">(</span><span class="n">detectors</span><span class="p">,</span> <span class="n">tth_start</span><span class="p">,</span> <span class="n">tth_end</span><span class="p">,</span> <span class="n">points</span><span class="o">=</span><span class="mi">11</span><span class="p">,</span> <span class="n">min_sep</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    run a coupled theta:2theta scan</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">min_sep</span> <span class="o">=</span> <span class="nb">abs</span><span class="p">(</span><span class="n">min_sep</span> <span class="ow">or</span> <span class="mf">2.4</span><span class="p">)</span>
    <span class="n">old_sep</span> <span class="o">=</span> <span class="n">th_tth_min</span><span class="o">.</span><span class="n">get</span><span class="p">()</span>

    <span class="c1"># check end points first!</span>
    <span class="k">if</span> <span class="nb">abs</span><span class="p">(</span><span class="n">tth_start</span><span class="o">/</span><span class="mi">2</span><span class="p">)</span> <span class="o">&lt;</span> <span class="n">min_sep</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span>
            <span class="s2">&quot;Starting point below allowed minimum:&quot;</span>
            <span class="sa">f</span><span class="s2">&quot; |</span><span class="si">{</span><span class="n">tth_start</span><span class="o">/</span><span class="mi">2</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2">| &lt; |</span><span class="si">{</span><span class="n">min_sep</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2">|&quot;</span><span class="p">)</span>
        <span class="k">return</span>
    <span class="k">if</span> <span class="nb">abs</span><span class="p">(</span><span class="n">tth_end</span><span class="o">/</span><span class="mi">2</span><span class="p">)</span> <span class="o">&lt;</span> <span class="n">min_sep</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span>
            <span class="s2">&quot;Ending point below allowed minimum:&quot;</span>
            <span class="sa">f</span><span class="s2">&quot; |</span><span class="si">{</span><span class="n">tth_end</span><span class="o">/</span><span class="mi">2</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2">| &lt; |</span><span class="si">{</span><span class="n">min_sep</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2">|&quot;</span><span class="p">)</span>
        <span class="k">return</span>

    <span class="k">yield from</span> <span class="n">bps</span><span class="o">.</span><span class="n">mv</span><span class="p">(</span><span class="n">th_tth_min</span><span class="p">,</span> <span class="n">min_sep</span><span class="p">)</span>
    <span class="k">yield from</span> <span class="n">bp</span><span class="o">.</span><span class="n">scan</span><span class="p">(</span>
        <span class="n">detectors</span><span class="p">,</span>
        <span class="n">ttheta</span><span class="p">,</span> <span class="n">tth_start</span><span class="p">,</span> <span class="n">tth_end</span><span class="p">,</span>
        <span class="n">theta</span><span class="p">,</span> <span class="n">tth_start</span><span class="o">/</span><span class="mi">2</span><span class="p">,</span> <span class="n">tth_end</span><span class="o">/</span><span class="mi">2</span><span class="p">,</span>
        <span class="n">points</span>
    <span class="p">)</span>

    <span class="c1"># reset the previous minimum</span>
    <span class="k">yield from</span> <span class="n">bps</span><span class="o">.</span><span class="n">mv</span><span class="p">(</span><span class="n">th_tth_min</span><span class="p">,</span> <span class="n">old_sep</span><span class="p">)</span>
</pre></div>
</div>
</div>
<p>Try a scan that we know will fail the test for minimum separation.</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[7]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">RE</span><span class="p">(</span><span class="n">th_tth_scan</span><span class="p">([</span><span class="n">noisy</span><span class="p">,</span> <span class="n">th_tth_permit</span><span class="p">],</span> <span class="mi">5</span><span class="p">,</span> <span class="mi">25</span><span class="p">,</span> <span class="n">points</span><span class="o">=</span><span class="mi">11</span><span class="p">,</span> <span class="n">min_sep</span><span class="o">=</span><span class="mi">3</span><span class="p">))</span>
</pre></div>
</div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
Starting point below allowed minimum: |2.5000| &lt; |3.0000|
</pre></div></div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[7]:
</pre></div>
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
()
</pre></div></div>
</div>
<p>Swap the two end points, that also fails.</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[8]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">RE</span><span class="p">(</span><span class="n">th_tth_scan</span><span class="p">([</span><span class="n">noisy</span><span class="p">,</span> <span class="n">th_tth_permit</span><span class="p">],</span> <span class="mi">25</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="n">points</span><span class="o">=</span><span class="mi">11</span><span class="p">,</span> <span class="n">min_sep</span><span class="o">=</span><span class="mi">3</span><span class="p">))</span>
</pre></div>
</div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
Ending point below allowed minimum: |2.5000| &lt; |3.0000|
</pre></div></div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[8]:
</pre></div>
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
()
</pre></div></div>
</div>
<p>This scan is successful.</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[9]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">RE</span><span class="p">(</span><span class="n">th_tth_scan</span><span class="p">([</span><span class="n">noisy</span><span class="p">,</span> <span class="n">th_tth_permit</span><span class="p">],</span> <span class="mi">12</span><span class="p">,</span> <span class="mi">8</span><span class="p">,</span> <span class="n">points</span><span class="o">=</span><span class="mi">11</span><span class="p">,</span> <span class="n">min_sep</span><span class="o">=</span><span class="mi">3</span><span class="p">))</span>
</pre></div>
</div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>


Transient Scan ID: 926     Time: 2023-04-11 18:47:33
Persistent Unique Scan ID: &#39;6ddca39f-503d-4481-bd83-03ecfbe21ae7&#39;
New stream: &#39;label_start_motor&#39;
New stream: &#39;primary&#39;
+-----------+------------+------------+------------+------------+---------------+
|   seq_num |       time |     ttheta |      theta |      noisy | th_tth_permit |
+-----------+------------+------------+------------+------------+---------------+
|         1 | 18:47:36.5 |    12.0000 |     6.0000 |      47659 |       1.00000 |
|         2 | 18:47:36.9 |    11.6000 |     5.8000 |      13759 |       1.00000 |
|         3 | 18:47:37.4 |    11.2000 |     5.6000 |        963 |       1.00000 |
|         4 | 18:47:37.9 |    10.8000 |     5.4000 |      10716 |       1.00000 |
|         5 | 18:47:38.4 |    10.4000 |     5.2000 |      62858 |       1.00000 |
|         6 | 18:47:38.9 |    10.0000 |     5.0000 |      79985 |       1.00000 |
|         7 | 18:47:39.4 |     9.6000 |     4.8000 |      18714 |       1.00000 |
|         8 | 18:47:39.9 |     9.2000 |     4.6000 |      65821 |       1.00000 |
|         9 | 18:47:40.4 |     8.8000 |     4.4000 |      12596 |       1.00000 |
|        10 | 18:47:40.9 |     8.4000 |     4.2000 |      86804 |       1.00000 |
|        11 | 18:47:41.4 |     8.0000 |     4.0000 |       6307 |       1.00000 |
+-----------+------------+------------+------------+------------+---------------+
generator scan [&#39;6ddca39f&#39;] (scan num: 926)
</pre></div></div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[9]:
</pre></div>
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
(&#39;6ddca39f-503d-4481-bd83-03ecfbe21ae7&#39;,)
</pre></div></div>
</div>
<p>So far, have not registered a permit denied. Have not encountered a condition where permit <em>would</em> be denied.</p>
</section>
<section id="Try-to-provoke-a-permit-denied">
<h2>Try to provoke a permit denied<a class="headerlink" href="#Try-to-provoke-a-permit-denied" title="Permalink to this heading">#</a></h2>
<p>Check the backlash parameters for 2theta motor. Use the custom motor class that provides the backlash parameters.</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[10]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># these two motors have backlash support</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">theta</span><span class="o">.</span><span class="n">backlash_distance</span><span class="o">.</span><span class="n">get</span><span class="p">()</span><span class="si">=}</span><span class="s2"> (</span><span class="si">{</span><span class="n">theta</span><span class="o">.</span><span class="n">motor_egu</span><span class="o">.</span><span class="n">get</span><span class="p">()</span><span class="si">}</span><span class="s2">)&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">theta</span><span class="o">.</span><span class="n">backlash_velocity</span><span class="o">.</span><span class="n">get</span><span class="p">()</span><span class="si">=}</span><span class="s2"> (</span><span class="si">{</span><span class="n">theta</span><span class="o">.</span><span class="n">motor_egu</span><span class="o">.</span><span class="n">get</span><span class="p">()</span><span class="si">}</span><span class="s2">/s)&quot;</span><span class="p">)</span>

<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">ttheta</span><span class="o">.</span><span class="n">backlash_distance</span><span class="o">.</span><span class="n">get</span><span class="p">()</span><span class="si">=}</span><span class="s2"> (</span><span class="si">{</span><span class="n">ttheta</span><span class="o">.</span><span class="n">motor_egu</span><span class="o">.</span><span class="n">get</span><span class="p">()</span><span class="si">}</span><span class="s2">)&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">ttheta</span><span class="o">.</span><span class="n">backlash_velocity</span><span class="o">.</span><span class="n">get</span><span class="p">()</span><span class="si">=}</span><span class="s2"> (</span><span class="si">{</span><span class="n">ttheta</span><span class="o">.</span><span class="n">motor_egu</span><span class="o">.</span><span class="n">get</span><span class="p">()</span><span class="si">}</span><span class="s2">/s)&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
theta.backlash_distance.get()=0.0 (degrees)
theta.backlash_velocity.get()=1.0 (degrees/s)
ttheta.backlash_distance.get()=0.0 (degrees)
ttheta.backlash_velocity.get()=2.0 (degrees/s)
</pre></div></div>
</div>
<p>Change (just) the backlash velocity and set a backlash distance for <code class="docutils literal notranslate"><span class="pre">ttheta</span></code>.</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[11]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="o">%</span><span class="k">mov</span> ttheta.backlash_distance 0.5 ttheta.backlash_velocity 0.2
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">ttheta</span><span class="o">.</span><span class="n">backlash_distance</span><span class="o">.</span><span class="n">get</span><span class="p">()</span><span class="si">=}</span><span class="s2"> (</span><span class="si">{</span><span class="n">ttheta</span><span class="o">.</span><span class="n">motor_egu</span><span class="o">.</span><span class="n">get</span><span class="p">()</span><span class="si">}</span><span class="s2">)&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">ttheta</span><span class="o">.</span><span class="n">backlash_velocity</span><span class="o">.</span><span class="n">get</span><span class="p">()</span><span class="si">=}</span><span class="s2"> (</span><span class="si">{</span><span class="n">ttheta</span><span class="o">.</span><span class="n">motor_egu</span><span class="o">.</span><span class="n">get</span><span class="p">()</span><span class="si">}</span><span class="s2">/s)&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
ttheta.backlash_distance.get()=0.5 (degrees)
ttheta.backlash_velocity.get()=0.2 (degrees/s)
</pre></div></div>
</div>
<p>Scan again over a shorter range.</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[12]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">RE</span><span class="p">(</span><span class="n">th_tth_scan</span><span class="p">([</span><span class="n">noisy</span><span class="p">,</span> <span class="n">th_tth_permit</span><span class="p">],</span> <span class="mi">7</span><span class="p">,</span> <span class="mi">6</span><span class="p">,</span> <span class="n">points</span><span class="o">=</span><span class="mi">4</span><span class="p">,</span> <span class="n">min_sep</span><span class="o">=</span><span class="mi">3</span><span class="p">))</span>
</pre></div>
</div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>


Transient Scan ID: 927     Time: 2023-04-11 18:47:42
Persistent Unique Scan ID: &#39;1d45b5ef-9268-494b-8fd7-37af3599b833&#39;
New stream: &#39;label_start_motor&#39;
New stream: &#39;primary&#39;
+-----------+------------+------------+------------+------------+---------------+
|   seq_num |       time |     ttheta |      theta |      noisy | th_tth_permit |
+-----------+------------+------------+------------+------------+---------------+
|         1 | 18:47:46.0 |     7.0000 |     3.5000 |      47643 |       1.00000 |
|         2 | 18:47:49.6 |     6.6667 |     3.3333 |      20673 |       1.00000 |
|         3 | 18:47:53.2 |     6.3333 |     3.1667 |      79528 |       1.00000 |
|         4 | 18:47:56.8 |     6.0000 |     3.0000 |      96895 |       0.00000 |
+-----------+------------+------------+------------+------------+---------------+
generator scan [&#39;1d45b5ef&#39;] (scan num: 927)
</pre></div></div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[12]:
</pre></div>
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
(&#39;1d45b5ef-9268-494b-8fd7-37af3599b833&#39;,)
</pre></div></div>
</div>
<p>Let’s monitor the signal <em>during</em> the scan so we can see if it changes and how often.</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[13]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">sd</span><span class="o">.</span><span class="n">monitors</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">th_tth_permit</span><span class="p">)</span>
</pre></div>
</div>
</div>
<p>Repeat the scan, collecting the new info. We’ll inspect the monitors after the scan is done. (The RunEngine returns a list of all the run uids created by the plan. Capture this list.)</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[14]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">uids</span> <span class="o">=</span> <span class="n">RE</span><span class="p">(</span><span class="n">th_tth_scan</span><span class="p">([</span><span class="n">noisy</span><span class="p">,</span> <span class="n">th_tth_permit</span><span class="p">],</span> <span class="mi">7</span><span class="p">,</span> <span class="mi">6</span><span class="p">,</span> <span class="n">points</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span> <span class="n">min_sep</span><span class="o">=</span><span class="mi">3</span><span class="p">))</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>


Transient Scan ID: 928     Time: 2023-04-11 18:47:57
Persistent Unique Scan ID: &#39;991bdcb1-f8d4-4e2f-a0eb-1dc16330481b&#39;
New stream: &#39;label_start_motor&#39;
New stream: &#39;th_tth_permit_monitor&#39;
New stream: &#39;primary&#39;
+-----------+------------+------------+------------+------------+---------------+
|   seq_num |       time |     ttheta |      theta |      noisy | th_tth_permit |
+-----------+------------+------------+------------+------------+---------------+
|         1 | 18:48:00.6 |     7.0000 |     3.5000 |      61886 |       1.00000 |
|         2 | 18:48:04.3 |     6.5000 |     3.2500 |      45252 |       1.00000 |
|         3 | 18:48:08.0 |     6.0000 |     3.0000 |      14221 |       0.00000 |
+-----------+------------+------------+------------+------------+---------------+
generator scan [&#39;991bdcb1&#39;] (scan num: 928)
</pre></div></div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[15]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">cat</span><span class="p">[</span><span class="n">uids</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span><span class="o">.</span><span class="n">th_tth_permit_monitor</span><span class="o">.</span><span class="n">read</span><span class="p">()[</span><span class="s2">&quot;th_tth_permit&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="o">.</span><span class="n">scatter</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="nboutput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[15]:
</pre></div>
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
&lt;matplotlib.collections.PathCollection at 0x7f34d8ff9c60&gt;
</pre></div></div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="../_images/howto__dynamic_limits_2motor_35_1.png" src="../_images/howto__dynamic_limits_2motor_35_1.png" />
</div>
</div>
<p>Aha! The first plot shows the monitored values. It is clear the signal <strong>does</strong> go to 0 and then come back to 1.</p>
<p>Look at the monitored data. First get the run object from databroker (indexed by the first uid in the list). From the run object, return the monitored data in a table. Python prints this object if it is not assigned. All this in one step.</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[16]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">cat</span><span class="o">.</span><span class="n">v1</span><span class="p">[</span><span class="n">uids</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span><span class="o">.</span><span class="n">table</span><span class="p">(</span><span class="s2">&quot;th_tth_permit_monitor&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[16]:
</pre></div>
</div>
<div class="output_area rendered_html docutils container">
<div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>time</th>
      <th>th_tth_permit</th>
    </tr>
    <tr>
      <th>seq_num</th>
      <th></th>
      <th></th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>1</th>
      <td>2023-04-11 23:47:57.239300013</td>
      <td>0.0</td>
    </tr>
    <tr>
      <th>2</th>
      <td>2023-04-11 23:47:57.804551840</td>
      <td>1.0</td>
    </tr>
    <tr>
      <th>3</th>
      <td>2023-04-11 23:48:01.110384226</td>
      <td>0.0</td>
    </tr>
    <tr>
      <th>4</th>
      <td>2023-04-11 23:48:02.918014526</td>
      <td>1.0</td>
    </tr>
    <tr>
      <th>5</th>
      <td>2023-04-11 23:48:04.721409321</td>
      <td>0.0</td>
    </tr>
  </tbody>
</table>
</div></div>
</div>
<p>We see some zero values (and then return to one) indicating occasional removal of the dynamic limit calculation permit. Since we only saw these when we added a backlash correction, we understand these dynamic violations of the limits are exactly what we hoped to intercept.</p>
</section>
<section id="Create-a-suspender">
<h2>Create a suspender<a class="headerlink" href="#Create-a-suspender" title="Permalink to this heading">#</a></h2>
<p>Block the RunEngine when the permit fails.</p>
<p>N.B. Might need to consider the special case where the permit fails when first starting the run. Why did that fail? (We’ll answer that soon.)</p>
<p>Following this example: <a class="reference external" href="https://blueskyproject.io/bluesky/state-machine.html#example-suspend-a-plan-if-the-beam-current-dips-low">https://blueskyproject.io/bluesky/state-machine.html#example-suspend-a-plan-if-the-beam-current-dips-low</a>, we’ll do similar but know that our signal is a boolean, that indicates <em>no permit</em> when low. Suspends interrupt the <code class="docutils literal notranslate"><span class="pre">RE</span></code> as long as the signal is invalid and automatically resume if the signal becomes valid again. Let’s see how this works here.</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[17]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">bluesky.suspenders</span> <span class="kn">import</span> <span class="n">SuspendBoolLow</span>
<span class="n">sus</span> <span class="o">=</span> <span class="n">SuspendBoolLow</span><span class="p">(</span><span class="n">th_tth_permit</span><span class="p">)</span>
<span class="n">RE</span><span class="o">.</span><span class="n">install_suspender</span><span class="p">(</span><span class="n">sus</span><span class="p">)</span>
</pre></div>
</div>
</div>
<p>Repeat the scan. Set the minimum separation low enough that the motor backlash will not trip the suspender near the end of the scan. After the previous move, the two motors are close enough that the suspender may trip at the start of the next scan, as the motors are sent to the first position. Let’s move <code class="docutils literal notranslate"><span class="pre">theta</span></code> a little lower to avoid that.</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[18]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Set a smaller minimum separation</span>
<span class="o">%</span><span class="k">xmode</span> Minimal
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">theta</span><span class="o">.</span><span class="n">position</span><span class="si">=}</span><span class="s2"> </span><span class="si">{</span><span class="n">ttheta</span><span class="o">.</span><span class="n">position</span><span class="si">=}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="o">%</span><span class="k">movr</span> theta -0.2
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">theta</span><span class="o">.</span><span class="n">position</span><span class="si">=}</span><span class="s2"> </span><span class="si">{</span><span class="n">ttheta</span><span class="o">.</span><span class="n">position</span><span class="si">=}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="n">uids</span> <span class="o">=</span> <span class="n">RE</span><span class="p">(</span><span class="n">th_tth_scan</span><span class="p">([</span><span class="n">noisy</span><span class="p">,</span> <span class="n">th_tth_permit</span><span class="p">],</span> <span class="mi">7</span><span class="p">,</span> <span class="mi">6</span><span class="p">,</span> <span class="n">points</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span> <span class="n">min_sep</span><span class="o">=</span><span class="mf">2.4</span><span class="p">))</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
Exception reporting mode: Minimal
theta.position=3.0000000000000004 ttheta.position=6.0
Suspender SuspendBoolLow(EpicsSignal(read_pv=&#39;gp:userCalc1.VAL&#39;, name=&#39;th_tth_permit&#39;, value=1.0, timestamp=1681256888.82624, tolerance=1e-05, auto_monitor=True, string=False, write_pv=&#39;gp:userCalc1.VAL&#39;, limits=False, put_complete=False), sleep=0, pre_plan=None, post_plan=None,tripped_message=) reports a return to nominal conditions. Will sleep for 0 seconds and then release suspension at 2023-04-11 18:48:08.
theta:  81%|████████████████████▏    | 0.1616/0.2 [00:00&lt;00:00,  1.11degrees/s]
theta: 100%|████████████████████████████| 0.2/0.2 [00:00&lt;00:00,  1.23s/degrees]
theta [In progress. No progress bar available.]

theta.position=2.8000000000000003 ttheta.position=6.0


Transient Scan ID: 929     Time: 2023-04-11 18:48:09
Persistent Unique Scan ID: &#39;52b208be-f1a3-42df-8cb4-9c790954e96c&#39;
New stream: &#39;label_start_motor&#39;
New stream: &#39;th_tth_permit_monitor&#39;
New stream: &#39;primary&#39;
+-----------+------------+------------+------------+------------+---------------+
|   seq_num |       time |     ttheta |      theta |      noisy | th_tth_permit |
+-----------+------------+------------+------------+------------+---------------+
|         1 | 18:48:12.5 |     7.0000 |     3.5000 |      76393 |       1.00000 |
|         2 | 18:48:16.2 |     6.5000 |     3.2500 |      33643 |       1.00000 |
|         3 | 18:48:19.9 |     6.0000 |     3.0000 |      73523 |       1.00000 |
+-----------+------------+------------+------------+------------+---------------+
generator scan [&#39;52b208be&#39;] (scan num: 929)
</pre></div></div>
</div>
<p>This succeeded because the minimum separation distance was set smaller than usual, to <code class="docutils literal notranslate"><span class="pre">2.4</span></code>, which allows for a backlash correction (of 0.5 in the <code class="docutils literal notranslate"><span class="pre">ttheta</span></code> motor) at the last point.</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[19]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># As in the previous step:</span>
<span class="o">%</span><span class="k">movr</span> theta -0.2

<span class="c1"># set the minimum separation to 2.5</span>
<span class="c1"># Likely the scan will fail due to the suspender when the m2 motor is taking a backlash correction and (m2-m1)&lt;3.</span>
<span class="n">uids</span> <span class="o">=</span> <span class="n">RE</span><span class="p">(</span><span class="n">th_tth_scan</span><span class="p">([</span><span class="n">noisy</span><span class="p">,</span> <span class="n">th_tth_permit</span><span class="p">],</span> <span class="mi">7</span><span class="p">,</span> <span class="mi">6</span><span class="p">,</span> <span class="n">points</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span> <span class="n">min_sep</span><span class="o">=</span><span class="mf">2.5</span><span class="p">))</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
theta: 100%|████████████████████████████| 0.2/0.2 [00:00&lt;00:00,  1.08s/degrees]
theta [In progress. No progress bar available.]



Transient Scan ID: 930     Time: 2023-04-11 18:48:34
Persistent Unique Scan ID: &#39;64c1bf12-041a-4e1c-ba92-0aef01a1e4e7&#39;
New stream: &#39;label_start_motor&#39;
New stream: &#39;th_tth_permit_monitor&#39;
New stream: &#39;primary&#39;
+-----------+------------+------------+------------+------------+---------------+
|   seq_num |       time |     ttheta |      theta |      noisy | th_tth_permit |
+-----------+------------+------------+------------+------------+---------------+
|         1 | 18:48:37.5 |     7.0000 |     3.5000 |      29638 |       1.00000 |
|         2 | 18:48:41.3 |     6.5000 |     3.2500 |       4031 |       1.00000 |
Suspending....To get prompt hit Ctrl-C twice to pause.
Suspension occurred at 2023-04-11 18:48:42.
Justification for this suspension:
Signal th_tth_permit is low
Suspender SuspendBoolLow(EpicsSignal(read_pv=&#39;gp:userCalc1.VAL&#39;, name=&#39;th_tth_permit&#39;, value=1.0, timestamp=1681256930.19391, tolerance=1e-05, auto_monitor=True, string=False, write_pv=&#39;gp:userCalc1.VAL&#39;, limits=False, put_complete=False), sleep=0, pre_plan=None, post_plan=None,tripped_message=) reports a return to nominal conditions. Will sleep for 0 seconds and then release suspension at 2023-04-11 18:48:50.
|         3 | 18:48:53.1 |     6.0000 |     3.0000 |      32567 |       1.00000 |
+-----------+------------+------------+------------+------------+---------------+
generator scan [&#39;64c1bf12&#39;] (scan num: 930)
</pre></div></div>
</div>
<p>The suspender tripped during the scan at the last move when <code class="docutils literal notranslate"><span class="pre">ttheta</span></code> was performing its backlash correction. Exactly what we wanted to happen. While moving the motors to the last point of the scan, <code class="docutils literal notranslate"><span class="pre">(m2-m1)&lt;2.5</span></code> was satisfied and the suspender tripped. The command line was not responsive. <em>To allow the scan to progress, the ``theta`` motor was moved from some other EPICS client outside of bluesky, allowing the scan to progress.</em> If the suspender delays the scan long enough, the scan will
timeout with a <code class="docutils literal notranslate"><span class="pre">FailedStatus</span></code> exception.</p>
<p>When the suspender trips, motion (in bluesky) is not permitted due to our computation of dynamic limits. We must move the motors so that the limit permit is restored before we can scan. We can move the motor from the command line or a GUI application. (This works since other EPICS clients such as the command line do not use this RunEngine instance. The suspender is checked only by this RunEngine.)</p>
<p>The signal (for the suspender) does not automatically clear since it is only computed when the motor readback value changes. We can clear this manually by moving the <code class="docutils literal notranslate"><span class="pre">theta</span></code> motor away from the <code class="docutils literal notranslate"><span class="pre">ttheta</span></code> motor. Yet, still, we encounter the problem when the two motors are close together either, as in this example.</p>
</section>
<section id="Conclusion">
<h2>Conclusion<a class="headerlink" href="#Conclusion" title="Permalink to this heading">#</a></h2>
<p>We can avoid an anticipated collision of instrument hardware by providing a RunEngine suspender tied to the value of an EPICS PV.</p>
</section>
</section>


                </article>
              
              
              
                <footer class="bd-footer-article">
                  
<div class="footer-article-items footer-article__inner">
  
    <div class="footer-article-item"><!-- Previous / next buttons -->
<div class="prev-next-area">
    <a class="left-prev"
       href="_doodle.html"
       title="previous page">
      <i class="fa-solid fa-angle-left"></i>
      <div class="prev-next-info">
        <p class="prev-next-subtitle">previous</p>
        <p class="prev-next-title">Linux Command &amp; Wait for Finish</p>
      </div>
    </a>
    <a class="right-next"
       href="_images_darks_flats.html"
       title="next page">
      <div class="prev-next-info">
        <p class="prev-next-subtitle">next</p>
        <p class="prev-next-title">Images, Darks, &amp; whites with EPICS area detector, ophyd, and Bluesky</p>
      </div>
      <i class="fa-solid fa-angle-right"></i>
    </a>
</div></div>
  
</div>

                </footer>
              
            </div>
            
            
              
                <div class="bd-sidebar-secondary bd-toc"><div class="sidebar-secondary-items sidebar-secondary__inner">

  <div class="sidebar-secondary-item">
  <div class="page-toc tocsection onthispage">
    <i class="fa-solid fa-list"></i> On this page
  </div>
  <nav class="bd-toc-nav page-toc">
    <ul class="visible nav section-nav flex-column">
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#Overview">Overview</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#Summary">Summary</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#EPICS-setup">EPICS setup</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#Bluesky-setup">Bluesky setup</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#Custom-Bluesky-plan-for-\theta:2\theta-scan">Custom Bluesky plan for <span class="math notranslate nohighlight">\(\theta:2\theta\)</span> scan</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#Try-to-provoke-a-permit-denied">Try to provoke a permit denied</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#Create-a-suspender">Create a suspender</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#Conclusion">Conclusion</a></li>
</ul>
  </nav></div>

  <div class="sidebar-secondary-item">
  <div class="tocsection sourcelink">
    <a href="../_sources/howto/_dynamic_limits_2motor.ipynb.txt">
      <i class="fa-solid fa-file-lines"></i> Show Source
    </a>
  </div>
</div>

</div></div>
              
            
          </div>
          <footer class="bd-footer-content">
            
          </footer>
        
      </main>
    </div>
  </div>
  
  <!-- Scripts loaded after <body> so the DOM is not blocked -->
  <script src="../_static/scripts/bootstrap.js?digest=e353d410970836974a52"></script>
<script src="../_static/scripts/pydata-sphinx-theme.js?digest=e353d410970836974a52"></script>

  <footer class="bd-footer">
<div class="bd-footer__inner bd-page-width">
  
    <div class="footer-items__start">
      
        <div class="footer-item">
  <p class="copyright">
    
      © Copyright 2023, APS BCDA.
      <br/>
    
  </p>
</div>
      
        <div class="footer-item">
  <p class="sphinx-version">
    Created using <a href="https://www.sphinx-doc.org/">Sphinx</a> 5.3.0.
    <br/>
  </p>
</div>
      
    </div>
  
  
    <div class="footer-items__end">
      
        <div class="footer-item"><p class="theme-version">
  Built with the <a href="https://pydata-sphinx-theme.readthedocs.io/en/stable/index.html">PyData Sphinx Theme</a> 0.13.3.
</p></div>
      
    </div>
  
</div>

  </footer>
  </body>
</html>